pipeline {
    agent any
    stages {
      stage ('SCM') {
        steps {
          sh 'rm -rf /tmp/source'
          sh 'mkdir /tmp/source'
          sh 'cd /tmp/source && git clone "https://github.com/shahar5/bakery-01.git"'
          sh 'cp /tmp/key/Bakery_Key.pem /tmp/source/bakery-01/shahar-PRs/bakery-project/'
        }
      }
      stage ('Terraform init') {
        steps {
          sh 'cd /tmp/source/bakery-01/shahar-PRs/bakery-project/'
          sh 'terraform init /tmp/source/bakery-01/shahar-PRs/bakery-project/'
        }
      }
      stage ('Terraform plan') {
        when {
            expression {
                params.action == 'Create'
            }
        }
        steps {
          withCredentials([file(credentialsId: 'Bakery_key', variable: 'aws_key_jen'), [$class: 'AmazonWebServicesCredentialsBinding', accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'aws_creds', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'], sshUserPrivateKey(credentialsId: 'aws_key', keyFileVariable: '', passphraseVariable: '', usernameVariable: 'con_user_jen')]) {
            sh "terraform plan -var 'region=${params.region}' -var 'connection-key=${aws_key_jen}' -var 'connection-user=${con_user_jen}' -var 'AWS_CREDS=${AWS_ACCESS_KEY_ID}:${AWS_SECRET_ACCESS_KEY}' -var 's3_folder_path=${params.s3_folder_path}' -var 'data_folder_path=${params.data_folder_path}' /tmp/source/bakery-01/shahar-PRs/bakery-project/"
          }
        }
      }
      stage ('Terraform apply') {
        when {
            expression {
                params.action == 'Create'
            }
        }
        steps {
          withCredentials([file(credentialsId: 'Bakery_key', variable: 'aws_key_jen'), [$class: 'AmazonWebServicesCredentialsBinding', accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 'aws_creds', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'], sshUserPrivateKey(credentialsId: 'aws_key', keyFileVariable: '', passphraseVariable: '', usernameVariable: 'con_user_jen')]) {
            sh "terraform apply --auto-approve -var 'region=${params.region}' -var 'connection-key=${aws_key_jen}' -var 'connection-user=${con_user_jen}' -var 'AWS_CREDS=${AWS_ACCESS_KEY_ID}:${AWS_SECRET_ACCESS_KEY}' -var 's3_folder_path=${params.s3_folder_path}' -var 'data_folder_path=${params.data_folder_path}' /tmp/source/bakery-01/shahar-PRs/bakery-project/"
          }
        }
      }
    }
}
